name: Deploy Plots to GitHub Pages

on:
  push:
    branches: [master]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: pages
  cancel-in-progress: true

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Create output directory
      run: mkdir -p data/output

    - name: Generate plots
      run: python main.py

    - name: Build Pages site
      run: |
        mkdir -p _site
        mv *.html _site/ 2>/dev/null || true

        # Generate index page linking to all plots
        cat > _site/index.html << 'HEREDOC'
        <!DOCTYPE html>
        <html lang="en">
        <head>
          <meta charset="utf-8">
          <meta name="viewport" content="width=device-width, initial-scale=1">
          <title>6N Fantasy Rugby Analysis</title>
          <style>
            body { font-family: system-ui, sans-serif; max-width: 700px; margin: 2rem auto; padding: 0 1rem; }
            h1 { border-bottom: 2px solid #333; padding-bottom: 0.5rem; }
            ul { list-style: none; padding: 0; }
            li { margin: 0.5rem 0; }
            a { color: #1a6; text-decoration: none; font-size: 1.1rem; }
            a:hover { text-decoration: underline; }
          </style>
        </head>
        <body>
          <h1>6N Fantasy Rugby Analysis</h1>
          <ul>
        HEREDOC

        for f in _site/*.html; do
          name=$(basename "$f")
          [ "$name" = "index.html" ] && continue
          label=$(echo "$name" | sed 's/\.html$//' | sed 's/_/ /g' | sed 's/\b\(.\)/\u\1/g')
          echo "    <li><a href=\"$name\">$label</a></li>" >> _site/index.html
        done

        cat >> _site/index.html << 'HEREDOC'
          </ul>
        </body>
        </html>
        HEREDOC

    - name: Upload Pages artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: _site

    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4

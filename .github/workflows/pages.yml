name: Deploy Plots to GitHub Pages

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: pages
  cancel-in-progress: true

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Create output directory
      run: mkdir -p data/output

    - name: Generate plots for each year
      run: |
        for year in 2025 2026; do
          echo "=== Generating plots for $year ==="
          python main.py --year "$year"
          mkdir -p "_site/$year"
          mv *.html "_site/$year/" 2>/dev/null || true
        done

    - name: Build Pages index
      run: |
        cat > _site/index.html << 'HEREDOC'
        <!DOCTYPE html>
        <html lang="en">
        <head>
          <meta charset="utf-8">
          <meta name="viewport" content="width=device-width, initial-scale=1">
          <title>6N Fantasy Rugby Analysis</title>
          <style>
            body { font-family: system-ui, sans-serif; max-width: 700px; margin: 2rem auto; padding: 0 1rem; }
            h1 { border-bottom: 2px solid #333; padding-bottom: 0.5rem; }
            h2 { margin-top: 1.5rem; color: #555; }
            ul { list-style: none; padding: 0; }
            li { margin: 0.5rem 0; }
            a { color: #1a6; text-decoration: none; font-size: 1.1rem; }
            a:hover { text-decoration: underline; }
          </style>
        </head>
        <body>
          <h1>6N Fantasy Rugby Analysis</h1>
        HEREDOC

        for year in 2025 2026; do
          echo "  <h2>$year</h2>" >> _site/index.html
          if ls _site/"$year"/*.html 1>/dev/null 2>&1; then
            echo "  <ul>" >> _site/index.html
            for f in _site/"$year"/*.html; do
              name=$(basename "$f")
              label=$(echo "$name" | sed 's/\.html$//' | sed 's/_/ /g' | sed 's/\b\(.\)/\u\1/g')
              echo "    <li><a href=\"$year/$name\">$label</a></li>" >> _site/index.html
            done
            echo "  </ul>" >> _site/index.html
          else
            echo "  <p style=\"color:#999;\">No data available yet.</p>" >> _site/index.html
          fi
        done

        cat >> _site/index.html << 'HEREDOC'
        </body>
        </html>
        HEREDOC

    - name: Upload Pages artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: _site

    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
